<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* A simple spinner animation */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        /* Aspect ratio for thumbnail containers */
        .aspect-h-9 {
            padding-bottom: 56.25%;
        }
        .aspect-w-16 {
            padding-bottom: 150%; /* Adjust for portrait thumbnails */
        }
    </style>
</head>
<body class="bg-zinc-900 text-white min-h-screen antialiased">
    <div id="root">
        <!-- Header -->
        <header class="sticky top-0 z-50 bg-zinc-900/80 backdrop-blur-lg border-b border-zinc-700 p-4 flex items-center justify-between">
            <h1 class="text-2xl sm:text-3xl font-bold text-violet-400 tracking-wider">Media Manager</h1>
        </header>

        <!-- Main Content Area -->
        <main class="container mx-auto p-4 md:p-6 lg:p-8" id="app-container">
            <!-- Content will be rendered here by JavaScript -->
        </main>
    </div>

    <script>
        // The base URL for your API server.
        const API_BASE_URL = 'http://localhost:1024/api';

        // --- STATE MANAGEMENT ---
        let content = [];
        let selectedContent = null;
        let searchQuery = '';
        let isLoading = false;
        let error = null;
        let view = 'home'; // 'home' or 'player'

        // --- DOM ELEMENTS ---
        const appContainer = document.getElementById('app-container');

        // --- HELPER FUNCTIONS ---

        // Function to create an SVG icon from a string.
        function createIcon(svgString, classes) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = svgString;
            const svg = tempDiv.firstChild;
            if (classes) {
                svg.className = classes;
            }
            return svg;
        }

        const icons = {
            home: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-home"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>',
            search: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>',
            play: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-play"><polygon points="5 3 19 12 5 21 5 3"/></svg>',
            loader: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-loader-2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>',
            x: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>'
        };

        // Renders a loading spinner.
        function renderLoading() {
            appContainer.innerHTML = '';
            const loadingDiv = document.createElement('div');
            loadingDiv.className = "flex justify-center items-center h-[50vh]";
            const spinner = createIcon(icons.loader, "h-10 w-10 text-violet-400 animate-spin");
            loadingDiv.appendChild(spinner);
            appContainer.appendChild(loadingDiv);
        }

        // Renders an error message.
        function renderError(message) {
            appContainer.innerHTML = '';
            const errorDiv = document.createElement('div');
            errorDiv.className = "flex justify-center items-center h-[50vh] text-red-400 text-center";
            errorDiv.innerHTML = `<p class="text-xl font-semibold">${message}</p>`;
            appContainer.appendChild(errorDiv);
        }

        // --- API & DATA FETCHING ---
        async function fetchContent(query = '') {
            isLoading = true;
            error = null;
            render();

            try {
                const movieUrl = `${API_BASE_URL}/movies${query ? `?search=${encodeURIComponent(query)}` : ''}`;
                const seriesUrl = `${API_BASE_URL}/series${query ? `?search=${encodeURIComponent(query)}` : ''}`;
                
                const [moviesResponse, seriesResponse] = await Promise.all([
                    fetch(movieUrl),
                    fetch(seriesUrl),
                ]);

                if (!moviesResponse.ok || !seriesResponse.ok) {
                    throw new Error('Failed to fetch content from the server.');
                }

                const moviesData = await moviesResponse.json();
                const seriesData = await seriesResponse.json();

                const seriesWithEpisodes = seriesData.flatMap(s =>
                    s.seasons.flatMap(season =>
                        season.episodes.map(episode => ({
                            ...episode,
                            seriesName: s.name,
                            thumbnail: episode.thumbnail || s.thumbnail,
                            title: `${s.name} - S${season.seasonNumber}E${episode.episodeNumber}: ${episode.title}`,
                            type: 'series'
                        }))
                    )
                );

                const combinedContent = [
                    ...moviesData.map(m => ({ ...m, type: 'movie' })),
                    ...seriesWithEpisodes
                ];
                
                content = combinedContent;
                if (combinedContent.length === 0) {
                    error = 'No results found. Try a different search term.';
                }
            } catch (err) {
                console.error('API fetch error:', err);
                error = 'An error occurred while fetching data. Please check the API URL and server status.';
            } finally {
                isLoading = false;
                render();
            }
        }

        // --- RENDERING FUNCTIONS ---

        function renderHomePage() {
            appContainer.innerHTML = `
                <div class="w-full max-w-2xl mx-auto mt-10">
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            ${icons.search}
                        </div>
                        <input
                            type="text"
                            placeholder="Search for movies or series..."
                            value="${searchQuery}"
                            id="search-input"
                            class="w-full pl-10 pr-4 py-3 rounded-full bg-zinc-800 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-violet-500"
                        />
                    </div>
                </div>
                <div class="mt-8 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 sm:gap-6" id="content-grid">
                    <!-- Content cards will be injected here -->
                </div>
            `;
            
            const contentGrid = document.getElementById('content-grid');
            content.forEach(item => {
                const card = document.createElement('div');
                card.className = "group cursor-pointer rounded-lg overflow-hidden shadow-lg transform hover:scale-105 transition-all duration-300 relative";
                card.dataset.id = item._id;

                const uniqueId = item._id || crypto.randomUUID();
                const titleText = item.title || item.name;
                const thumbnailUrl = item.thumbnail;

                card.innerHTML = `
                    <div class="w-full relative pb-[150%]">
                        <img
                            src="${thumbnailUrl}"
                            alt="${titleText}"
                            class="absolute inset-0 w-full h-full object-cover transition-opacity duration-300 group-hover:opacity-80"
                            onerror="this.onerror=null;this.src='https://placehold.co/600x900/1f2937/d1d5db?text=No+Image';"
                        />
                    </div>
                    <div class="absolute inset-0 bg-gradient-to-t from-black to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                    <div class="absolute bottom-0 left-0 p-4 w-full">
                        <h3 class="text-white text-sm sm:text-base font-semibold truncate group-hover:whitespace-normal group-hover:overflow-visible group-hover:text-clip">
                            ${titleText}
                        </h3>
                    </div>
                `;
                contentGrid.appendChild(card);
            });

            // Add event listener for searching
            const searchInput = document.getElementById('search-input');
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    searchQuery = e.target.value;
                    fetchContent(searchQuery);
                }
            });
            searchInput.addEventListener('input', (e) => {
                searchQuery = e.target.value;
            });
        }

        function renderPlayerPage() {
            if (!selectedContent) {
                view = 'home';
                render();
                return;
            }

            const titleText = selectedContent.title || selectedContent.name;
            const seriesName = selectedContent.type === 'series' ? selectedContent.seriesName : '';

            appContainer.innerHTML = `
                <div class="p-4 sm:p-8 flex flex-col items-center">
                    <button id="back-button" class="self-start mb-4 py-2 px-4 rounded-full bg-zinc-700 text-white hover:bg-violet-600 transition-colors flex items-center gap-2">
                        ${icons.home}
                        Back to Home
                    </button>
                    <div class="w-full max-w-4xl rounded-lg overflow-hidden shadow-2xl">
                        <div class="aspect-w-16 aspect-h-9" style="position: relative; padding-bottom: 56.25%;">
                            <iframe
                                src="${selectedContent.streamingUrl}"
                                frameborder="0"
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                allowfullscreen
                                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"
                            ></iframe>
                        </div>
                    </div>
                    <div class="mt-6 text-center">
                        <h2 class="text-3xl font-bold text-white mb-2">${titleText}</h2>
                        ${seriesName ? `<p class="text-violet-400 text-lg">${seriesName}</p>` : ''}
                    </div>
                </div>
            `;

            // Add event listener for the back button
            document.getElementById('back-button').addEventListener('click', () => {
                view = 'home';
                selectedContent = null;
                render();
            });
        }

        // --- MAIN RENDER FUNCTION ---
        function render() {
            if (isLoading) {
                renderLoading();
            } else if (error) {
                renderError(error);
            } else {
                if (view === 'home') {
                    renderHomePage();
                } else if (view === 'player') {
                    renderPlayerPage();
                }
            }
        }

        // --- EVENT LISTENERS ---

        // Listen for clicks on the content grid
        appContainer.addEventListener('click', (e) => {
            const card = e.target.closest('[data-id]');
            if (card) {
                const id = card.dataset.id;
                selectedContent = content.find(item => item._id === id);
                if (selectedContent) {
                    view = 'player';
                    render();
                }
            }
        });

        // Initial load
        window.onload = () => {
            fetchContent();
        };
    </script>
</body>
</html>

