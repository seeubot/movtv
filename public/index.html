<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamVault - Your Media Library</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Custom styles for a cleaner look -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Custom scrollbar for the episode selector */
        .episode-selector::-webkit-scrollbar {
            width: 8px;
        }
        .episode-selector::-webkit-scrollbar-track {
            background: #1f2937;
        }
        .episode-selector::-webkit-scrollbar-thumb {
            background-color: #4ecdc4;
            border-radius: 20px;
            border: 2px solid #1f2937;
        }
        .episode-selector {
            scrollbar-width: thin;
            scrollbar-color: #4ecdc4 #1f2937;
        }

        .media-card {
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .media-card:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .search-input:focus {
            border-color: #4ecdc4;
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.02);
            box-shadow: 0 0 30px rgba(78, 205, 196, 0.3);
        }

        .video-player-modal {
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
        }

        .player-container {
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }

        .close-player:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(90deg);
        }

        .episode-btn:hover {
            background: rgba(78, 205, 196, 0.2);
            border-color: #4ecdc4;
        }

        .episode-btn.active {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border-color: transparent;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen flex flex-col items-center p-4">

    <!-- Main Content Container -->
    <div class="container mx-auto max-w-7xl flex-grow">

        <!-- Header Section - Initially Hidden -->
        <header id="header-container" class="hidden flex flex-col md:flex-row items-center justify-between pb-8 border-b border-gray-700 mb-8">
            <h1 class="text-4xl font-extrabold text-white">Media Manager</h1>
            <div id="stats-container" class="flex items-center space-x-4 mt-4 md:mt-0">
                <!-- Stats will be dynamically injected here by JavaScript -->
            </div>
        </header>

        <!-- Search Bar Section - Always visible -->
        <div id="search-container" class="flex justify-center my-12 w-full">
            <input type="text" id="search-input" placeholder="Search for movies or series..." class="w-full max-w-xl p-4 text-xl rounded-full bg-gray-800 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent">
        </div>

        <!-- Main Content Area - Initially Hidden -->
        <div id="content-area" class="hidden">
            <!-- Navigation Tabs -->
            <div class="flex space-x-4 mb-8 border-b border-gray-700">
                <button id="movies-tab" class="tab-button py-2 px-4 text-lg font-medium text-white border-b-2 border-teal-400">Movies</button>
                <button id="series-tab" class="tab-button py-2 px-4 text-lg font-medium text-gray-400 hover:text-gray-200">Series</button>
            </div>

            <!-- Loading and Error messages -->
            <div id="loading-message" class="flex items-center justify-center py-12">
                <p class="text-xl font-medium">Loading data...</p>
            </div>

            <div id="error-message" class="hidden text-center text-red-400 p-4 text-xl">
                <p>Failed to fetch data from the API. Please check if the backend is running.</p>
            </div>

            <!-- Media content will be rendered here by JavaScript -->
            <div id="media-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
        </div>

    </div>

    <!-- Video Player Modal -->
    <div class="video-player-modal fixed inset-0 z-50 hidden flex items-center justify-center p-4" id="videoModal">
        <div class="player-container w-full max-w-4xl bg-gray-800 text-white">
            <div class="player-header flex justify-between items-center p-4 border-b border-gray-700">
                <div class="player-title text-xl font-semibold" id="playerTitle">Now Playing</div>
                <button class="close-player text-2xl font-bold transition-transform duration-300" onclick="closePlayer()">âœ•</button>
            </div>
            <video class="video-player w-full max-h-[70vh]" id="videoPlayer" controls autoplay>
                Your browser does not support the video tag.
            </video>
            <!-- Episode Selector for Series -->
            <div class="episode-selector p-4 bg-gray-800 max-h-48 overflow-y-auto" id="episodeSelector" style="display: none;"></div>
        </div>
    </div>


    <!-- JavaScript for fetching data and rendering the UI -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Base URL for the backend API.
            const API_BASE_URL = 'https://future-ester-seeutech-645c6129.koyeb.app/api';

            // DOM elements
            const headerContainer = document.getElementById('header-container');
            const searchInput = document.getElementById('search-input');
            const statsContainer = document.getElementById('stats-container');
            const contentArea = document.getElementById('content-area');
            const loadingMessage = document.getElementById('loading-message');
            const errorMessage = document.getElementById('error-message');
            const mediaGrid = document.getElementById('media-grid');
            const moviesTab = document.getElementById('movies-tab');
            const seriesTab = document.getElementById('series-tab');
            const videoModal = document.getElementById('videoModal');
            const videoPlayer = document.getElementById('videoPlayer');
            const playerTitle = document.getElementById('playerTitle');
            const episodeSelector = document.getElementById('episodeSelector');
            
            // Store the fetched data and current state
            let allMovies = [];
            let allSeries = [];
            let currentSeries = null;
            let activeTab = 'movies';

            // Function to fetch all data from the API
            const fetchAllData = async () => {
                loadingMessage.classList.remove('hidden');
                try {
                    const [moviesResponse, seriesResponse, statsResponse] = await Promise.all([
                        fetch(`${API_BASE_URL}/movies`),
                        fetch(`${API_BASE_URL}/series`),
                        fetch(`${API_BASE_URL}/stats`)
                    ]);
                    
                    if (!moviesResponse.ok || !seriesResponse.ok || !statsResponse.ok) {
                        throw new Error('One or more API responses were not successful.');
                    }

                    allMovies = await moviesResponse.json();
                    allSeries = await seriesResponse.json();
                    const stats = await statsResponse.json();
                    updateStats(stats);
                    loadingMessage.classList.add('hidden');
                } catch (e) {
                    console.error("Failed to fetch data:", e);
                    errorMessage.classList.remove('hidden');
                    loadingMessage.classList.add('hidden');
                }
            };
            
            // Function to handle search input
            const handleSearch = async () => {
                const query = searchInput.value.toLowerCase().trim();

                // Hide all content until at least 3 characters are typed
                if (query.length < 3) {
                    contentArea.classList.add('hidden');
                    headerContainer.classList.add('hidden');
                    mediaGrid.innerHTML = '';
                    return;
                }

                // Show content area and header
                contentArea.classList.remove('hidden');
                headerContainer.classList.remove('hidden');
                
                // If data hasn't been fetched yet, fetch it.
                if (allMovies.length === 0 && allSeries.length === 0) {
                    await fetchAllData();
                }

                // Filter the fetched data based on the query
                const filteredMovies = allMovies.filter(movie => movie.name.toLowerCase().includes(query));
                const filteredSeries = allSeries.filter(series => series.name.toLowerCase().includes(query));
                
                // Update stats based on filtered data
                const filteredStats = {
                    movies: filteredMovies.length,
                    series: filteredSeries.length,
                    episodes: filteredSeries.reduce((total, series) => total + (series.seasons?.length || 0), 0) // Simplified episode count
                };
                updateStats(filteredStats);

                // Render the filtered content
                renderContent(filteredMovies, filteredSeries);
            };

            // Function to update the stats in the header
            const updateStats = (currentStats) => {
                statsContainer.innerHTML = `
                    <div class="flex flex-col items-center">
                        <span class="text-2xl font-bold text-teal-400">${currentStats.movies}</span>
                        <span class="text-sm text-gray-400">Movies</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <span class="text-2xl font-bold text-purple-400">${currentStats.series}</span>
                        <span class="text-sm text-gray-400">Series</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <span class="text-2xl font-bold text-orange-400">${currentStats.episodes}</span>
                        <span class="text-sm text-gray-400">Episodes</span>
                    </div>
                `;
            };

            // Function to render a single media card element
            const createMediaCard = (item, type) => {
                const card = document.createElement('div');
                card.className = 'media-card relative w-full overflow-hidden bg-gray-800 rounded-2xl shadow-xl cursor-pointer';

                const thumbnail = item.thumbnail || 'https://placehold.co/400x600/1f2937/d1d5db?text=No+Image';
                const seasonsInfo = type === 'series' && item.seasons
                    ? `<p class="text-sm text-gray-400 mt-1">${item.seasons.length} ${item.seasons.length > 1 ? 'seasons' : 'season'}</p>`
                    : '';

                card.innerHTML = `
                    <img src="${thumbnail}" alt="${item.name}" class="w-full h-80 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/400x600/1f2937/d1d5db?text=No+Image';">
                    <div class="p-4">
                        <h3 class="text-lg font-semibold text-white truncate">${item.name}</h3>
                        ${seasonsInfo}
                    </div>
                `;

                // Add click event to play video or load series details
                if (type === 'series') {
                    card.addEventListener('click', () => loadSeriesDetails(item._id));
                } else {
                    card.addEventListener('click', () => playVideo(item.streamingUrl, item.name, 'movie'));
                }

                return card;
            };

            // Function to render the media content based on the active tab
            const renderContent = (moviesToRender, seriesToRender) => {
                mediaGrid.innerHTML = ''; // Clear previous content

                const dataToRender = activeTab === 'movies' ? moviesToRender : seriesToRender;
                const type = activeTab === 'movies' ? 'movie' : 'series';
                const emptyMessage = `
                    <div class="col-span-full text-center text-gray-500 text-lg py-12">
                        No ${activeTab} found for this search query.
                    </div>
                `;

                if (dataToRender.length > 0) {
                    dataToRender.forEach(item => {
                        const card = createMediaCard(item, type);
                        mediaGrid.appendChild(card);
                    });
                } else {
                    mediaGrid.innerHTML = emptyMessage;
                }
            };
            
            // Function to fetch and display episodes for a series, then play the first one
            const loadSeriesDetails = async (seriesId) => {
                try {
                    const response = await fetch(`${API_BASE_URL}/series/${seriesId}`);
                    if (!response.ok) {
                        throw new Error('Failed to fetch series details.');
                    }
                    currentSeries = await response.json();
                    
                    if (currentSeries.seasons && currentSeries.seasons.length > 0 && 
                        currentSeries.seasons[0].episodes && currentSeries.seasons[0].episodes.length > 0) {
                        const firstEpisode = currentSeries.seasons[0].episodes[0];
                        const episodeTitle = `${currentSeries.name} - S${currentSeries.seasons[0].seasonNumber}E${firstEpisode.episodeNumber}: ${firstEpisode.title}`;
                        
                        playVideo(firstEpisode.streamingUrl, episodeTitle, 'series');
                    } else {
                        console.error('No episodes available for this series.');
                    }
                } catch (e) {
                    console.error('Error loading series details:', e);
                }
            };

            // Function to handle tab switching
            const switchTab = (tab) => {
                activeTab = tab;
                if (tab === 'movies') {
                    moviesTab.classList.add('text-white', 'border-b-2', 'border-teal-400');
                    seriesTab.classList.remove('text-white', 'border-b-2', 'border-purple-400');
                    seriesTab.classList.add('text-gray-400', 'hover:text-gray-200');
                } else {
                    seriesTab.classList.add('text-white', 'border-b-2', 'border-purple-400');
                    moviesTab.classList.remove('text-white', 'border-b-2', 'border-teal-400');
                    moviesTab.classList.add('text-gray-400', 'hover:text-gray-200');
                }

                // Re-render content based on the current search query
                const query = searchInput.value.toLowerCase().trim();
                const filteredMovies = allMovies.filter(movie => movie.name.toLowerCase().includes(query));
                const filteredSeries = allSeries.filter(series => series.name.toLowerCase().includes(query));
                renderContent(filteredMovies, filteredSeries);
            };

            // Function to handle playing the video
            window.playVideo = (url, title, type) => {
                playerTitle.textContent = title;
                videoPlayer.src = url;
                videoModal.classList.remove('hidden');
                
                // Show episode selector for series
                if (type === 'series' && currentSeries) {
                    episodeSelector.style.display = 'block';
                    displayEpisodeSelector();
                } else {
                    episodeSelector.style.display = 'none';
                }
                
                videoPlayer.play().catch(e => {
                    console.error('Error playing video:', e);
                    // Use a custom message instead of alert
                });
            };

            // Function to display the list of episodes
            window.displayEpisodeSelector = () => {
                episodeSelector.innerHTML = currentSeries.seasons.map(season => `
                    <div class="season-group mb-4">
                        <div class="season-title text-lg font-semibold text-teal-400 mb-2">Season ${season.seasonNumber}</div>
                        <div class="episode-list grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2">
                            ${season.episodes.map(episode => `
                                <button class="episode-btn p-2 rounded-lg bg-gray-700 text-left transition-colors duration-200 hover:bg-teal-700" 
                                        onclick="switchEpisode('${episode.streamingUrl}', '${currentSeries.name}', ${season.seasonNumber}, ${episode.episodeNumber}, '${episode.title.replace(/'/g, "\\'")}')">
                                    <span class="font-bold">E${episode.episodeNumber}:</span> ${episode.title}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
                
                // Set the active class on the currently playing episode button
                const currentUrl = videoPlayer.src;
                document.querySelectorAll('.episode-btn').forEach(btn => {
                    if (btn.onclick.toString().includes(currentUrl)) {
                        btn.classList.add('bg-teal-600', 'text-white');
                    } else {
                        btn.classList.remove('bg-teal-600', 'text-white');
                    }
                });
            };

            // Function to switch to a new episode
            window.switchEpisode = (url, seriesName, seasonNumber, episodeNumber, episodeTitle) => {
                playerTitle.textContent = `${seriesName} - S${seasonNumber}E${episodeNumber}: ${episodeTitle}`;
                videoPlayer.src = url;
                videoPlayer.play().catch(e => {
                    console.error('Error playing video:', e);
                });
                
                // Update active episode button
                document.querySelectorAll('.episode-btn').forEach(btn => btn.classList.remove('bg-teal-600', 'text-white'));
                event.target.classList.add('bg-teal-600', 'text-white');
            };

            // Function to close the video player modal
            window.closePlayer = () => {
                videoPlayer.pause();
                videoPlayer.src = '';
                videoModal.classList.add('hidden');
                currentSeries = null;
            };

            // Event listeners
            searchInput.addEventListener('input', handleSearch);
            moviesTab.addEventListener('click', () => switchTab('movies'));
            seriesTab.addEventListener('click', () => switchTab('series'));
            
            // Close modal when clicking outside
            videoModal.addEventListener('click', (event) => {
                if (event.target === videoModal) {
                    closePlayer();
                }
            });
            
            // Keyboard shortcut for closing modal
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !videoModal.classList.contains('hidden')) {
                    closePlayer();
                }
            });
        });
    </script>
</body>
</html>
