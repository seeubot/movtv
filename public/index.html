<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        .aspect-w-16 {
            padding-bottom: 150%;
        }
        /* Custom scrollbar for episode list */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #27272a;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #a78bfa;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #8b5cf6;
        }
        .plyr--full-frame {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            background-color: black;
        }
    </style>
</head>
<body class="bg-zinc-900 text-white min-h-screen antialiased">
    <div id="root">
        <!-- Header -->
        <header id="header" class="sticky top-0 z-50 bg-zinc-900/80 backdrop-blur-lg border-b border-zinc-700 p-4 flex items-center justify-between">
            <h1 class="text-2xl sm:text-3xl font-bold text-violet-400 tracking-wider">Media Manager</h1>
        </header>

        <!-- Main Content Area -->
        <main class="container mx-auto p-4 md:p-6 lg:p-8 flex-grow" id="app-container">
            <!-- Content will be rendered here by JavaScript -->
        </main>
    </div>

    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.8"></script>
    <script>
        const API_BASE_URL = 'https://future-ester-seeutech-645c6129.koyeb.app/api';

        // --- STATE MANAGEMENT ---
        let content = [];
        let selectedContent = null;
        let selectedSeries = null;
        let searchQuery = '';
        let isLoading = false;
        let error = null;
        let view = 'home'; // 'home', 'series', or 'player'

        // --- DOM ELEMENTS ---
        const appContainer = document.getElementById('app-container');
        const header = document.getElementById('header');

        // --- HELPER FUNCTIONS ---
        function createIcon(svgString, classes) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = svgString;
            const svg = tempDiv.firstChild;
            if (classes) {
                svg.className = classes;
            }
            return svg;
        }

        const icons = {
            home: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-home"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>',
            search: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>',
            play: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-play"><polygon points="5 3 19 12 5 21 5 3"/></svg>',
            loader: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-loader-2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>',
            x: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>',
            list: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-list"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>'
        };

        function renderLoading() {
            appContainer.innerHTML = '';
            const loadingDiv = document.createElement('div');
            loadingDiv.className = "flex justify-center items-center h-[50vh]";
            const spinner = createIcon(icons.loader, "h-10 w-10 text-violet-400 animate-spin");
            loadingDiv.appendChild(spinner);
            appContainer.appendChild(loadingDiv);
        }

        function renderError(message) {
            appContainer.innerHTML = '';
            const errorDiv = document.createElement('div');
            errorDiv.className = "flex flex-col justify-center items-center h-[50vh] text-red-400 text-center space-y-4";
            errorDiv.innerHTML = `
                <p class="text-xl font-semibold">${message}</p>
                <p class="text-gray-400 text-sm">Please ensure your backend server is running and the API URL is correct.</p>
            `;
            appContainer.appendChild(errorDiv);
        }

        // --- API & DATA FETCHING ---
        async function fetchContent(query) {
            if (query.length < 3) {
                content = [];
                renderContentGrid();
                return;
            }

            isLoading = true;
            error = null;
            renderContentGrid();

            try {
                const [moviesResponse, seriesResponse] = await Promise.all([
                    fetch(`${API_BASE_URL}/movies?search=${encodeURIComponent(query)}`),
                    fetch(`${API_BASE_URL}/series?search=${encodeURIComponent(query)}`),
                ]);

                if (!moviesResponse.ok || !seriesResponse.ok) {
                    throw new Error('Failed to fetch content from the server.');
                }

                const moviesData = await moviesResponse.json();
                const seriesData = await seriesResponse.json();

                const combinedContent = [
                    ...moviesData.map(m => ({ ...m, type: 'movie' })),
                    ...seriesData.map(s => ({ ...s, type: 'series' }))
                ];
                
                content = combinedContent;
                if (combinedContent.length === 0) {
                    error = 'No results found. Try a different search term.';
                }
            } catch (err) {
                console.error('API fetch error:', err);
                error = 'An error occurred while fetching data. Please check the API URL and server status.';
            } finally {
                isLoading = false;
                renderContentGrid();
            }
        }
        
        async function fetchSeriesDetails(seriesId) {
            isLoading = true;
            error = null;
            appContainer.innerHTML = '';
            renderLoading();
            try {
                const response = await fetch(`${API_BASE_URL}/series/${seriesId}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch series details.');
                }
                const seriesData = await response.json();
                selectedSeries = seriesData;
                view = 'series';
            } catch (err) {
                console.error('API fetch error:', err);
                error = 'Failed to load series details.';
            } finally {
                isLoading = false;
                render();
            }
        }

        // --- RENDERING FUNCTIONS ---
        function renderHomePage() {
            appContainer.innerHTML = `
                <div class="flex flex-col items-center justify-center pt-16 pb-8 text-center">
                    <h2 class="text-4xl font-bold text-gray-200 mb-6">Discover Your Next Favorite</h2>
                    <div class="w-full max-w-2xl">
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">
                                ${icons.search}
                            </div>
                            <input
                                type="text"
                                placeholder="Search for movies or series..."
                                value="${searchQuery}"
                                id="search-input"
                                class="w-full pl-10 pr-4 py-3 rounded-full bg-zinc-800 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-violet-500"
                            />
                        </div>
                    </div>
                </div>
                <div id="content-display">
                    <!-- The content grid or error message will be rendered here -->
                </div>
            `;
            const searchInput = document.getElementById('search-input');
            searchInput.addEventListener('input', (e) => {
                searchQuery = e.target.value;
                fetchContent(searchQuery);
            });
            renderContentGrid();
        }

        function renderContentGrid() {
            const contentDisplay = document.getElementById('content-display');
            if (!contentDisplay) return;

            if (isLoading) {
                contentDisplay.innerHTML = `<div class="flex justify-center items-center h-[50vh]"><svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-loader-2 text-violet-400 animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg></div>`;
                return;
            }

            if (error) {
                contentDisplay.innerHTML = `<div class="flex justify-center items-center h-[50vh] text-red-400 text-center"><p>${error}</p></div>`;
                return;
            }

            contentDisplay.innerHTML = `
                <div class="mt-8 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 sm:gap-6" id="content-grid">
                    <!-- Content cards will be injected here -->
                </div>
            `;
            
            const contentGrid = document.getElementById('content-grid');
            if (contentGrid) {
                content.forEach(item => {
                    const card = document.createElement('div');
                    card.className = "group cursor-pointer rounded-lg overflow-hidden shadow-lg transform hover:scale-105 transition-all duration-300 relative";
                    card.dataset.id = item._id;
                    card.dataset.type = item.type;

                    const titleText = item.name;
                    const thumbnailUrl = item.thumbnail;

                    card.innerHTML = `
                        <div class="w-full relative pb-[150%]">
                            <img
                                src="${thumbnailUrl}"
                                alt="${titleText}"
                                class="absolute inset-0 w-full h-full object-cover transition-opacity duration-300 group-hover:opacity-80"
                                onerror="this.onerror=null;this.src='https://placehold.co/600x900/1f2937/d1d5db?text=No+Image';"
                            />
                        </div>
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-end p-4">
                             <h3 class="text-white text-sm sm:text-base font-semibold truncate group-hover:whitespace-normal group-hover:overflow-visible group-hover:text-clip">
                                ${titleText}
                            </h3>
                        </div>
                    `;
                    contentGrid.appendChild(card);
                });
            }
        }

        function renderSeriesPage() {
            if (!selectedSeries) {
                view = 'home';
                render();
                return;
            }

            appContainer.innerHTML = `
                <div class="p-4 sm:p-8">
                    <button id="back-to-home-button" class="mb-4 py-2 px-4 rounded-full bg-zinc-700 text-white hover:bg-violet-600 transition-colors flex items-center gap-2">
                        ${icons.home}
                        Back to Search
                    </button>
                    <div class="flex flex-col md:flex-row gap-8">
                        <div class="flex-shrink-0 w-full md:w-64">
                            <img src="${selectedSeries.thumbnail}" alt="${selectedSeries.name}" class="rounded-lg shadow-lg w-full" onerror="this.onerror=null;this.src='https://placehold.co/600x900/1f2937/d1d5db?text=No+Image';">
                        </div>
                        <div class="flex-grow">
                            <h2 class="text-4xl font-bold text-white mb-4">${selectedSeries.name}</h2>
                            <p class="text-gray-400 mb-6">${selectedSeries.synopsis}</p>
                            <h3 class="text-2xl font-semibold text-violet-400 mb-4">Seasons & Episodes</h3>
                            <div id="seasons-container" class="space-y-4">
                                <!-- Seasons will be injected here -->
                            </div>
                        </div>
                    </div>
                </div>
            `;

            const seasonsContainer = document.getElementById('seasons-container');
            selectedSeries.seasons.sort((a,b) => a.seasonNumber - b.seasonNumber).forEach(season => {
                const seasonDiv = document.createElement('div');
                seasonDiv.className = 'bg-zinc-800 rounded-lg p-4 shadow';
                seasonDiv.innerHTML = `<h4 class="text-xl font-bold text-gray-100 mb-2">Season ${season.seasonNumber}</h4>`;
                
                const episodesList = document.createElement('div');
                episodesList.className = 'grid grid-cols-1 md:grid-cols-2 gap-2';

                season.episodes.sort((a,b) => a.episodeNumber - b.episodeNumber).forEach(episode => {
                    const episodeDiv = document.createElement('div');
                    episodeDiv.className = 'flex items-center gap-4 p-3 bg-zinc-700 rounded-lg hover:bg-violet-600 cursor-pointer transition-colors';
                    episodeDiv.dataset.type = 'episode';
                    episodeDiv.dataset.id = episode._id;
                    episodeDiv.dataset.streamingUrl = episode.streamingUrl;
                    episodeDiv.dataset.title = `${selectedSeries.name} - S${season.seasonNumber}E${episode.episodeNumber}`;
                    episodeDiv.dataset.seasonId = season.seasonNumber;
                    episodeDiv.dataset.seriesId = selectedSeries._id;

                    episodeDiv.innerHTML = `
                        <div class="flex-shrink-0 text-violet-300">
                            <div class="w-10 h-10 flex items-center justify-center rounded-full bg-violet-500/20">
                                ${icons.play}
                            </div>
                        </div>
                        <div class="flex-grow">
                            <p class="font-semibold text-gray-200">E${episode.episodeNumber}: ${episode.title}</p>
                        </div>
                    `;
                    episodesList.appendChild(episodeDiv);
                });
                seasonDiv.appendChild(episodesList);
                seasonsContainer.appendChild(seasonDiv);
            });

            document.getElementById('back-to-home-button').addEventListener('click', () => {
                selectedSeries = null;
                view = 'home';
                render();
            });
        }

        function renderPlayerPage() {
            if (!selectedContent || !selectedContent.streamingUrl) {
                error = 'Video content is unavailable.';
                view = 'home';
                render();
                return;
            }

            const titleText = selectedContent.title || selectedContent.name;
            const isSeries = selectedContent.type === 'series' && selectedSeries;
            const seriesName = isSeries ? selectedSeries.name : '';
            const currentSeason = isSeries ? selectedSeries.seasons.find(s => s.seasonNumber == selectedContent.seasonId) : null;
            const currentEpisodes = currentSeason ? currentSeason.episodes.sort((a,b) => a.episodeNumber - b.episodeNumber) : [];

            // Hide the header for the player view
            header.classList.add('hidden');

            appContainer.innerHTML = `
                <div class="flex flex-col lg:flex-row gap-4 p-0 md:p-8 w-full h-full">
                    <div class="flex-grow flex-col">
                        <div class="w-full h-auto lg:h-[75vh] rounded-lg overflow-hidden shadow-2xl bg-black">
                            <video id="video-player" class="plyr" controls autoplay>
                                <source src="${selectedContent.streamingUrl}" type="video/mp4">
                            </video>
                        </div>
                        <div class="mt-6 p-4 md:p-0">
                            <button id="back-button" class="mb-4 py-2 px-4 rounded-full bg-zinc-700 text-white hover:bg-violet-600 transition-colors flex items-center gap-2">
                                ${icons.x}
                                Back to ${isSeries ? 'Series' : 'Search'}
                            </button>
                            <h2 class="text-3xl font-bold text-white">${titleText}</h2>
                            ${isSeries ? `<p class="text-violet-400 text-lg">${seriesName}</p>` : ''}
                        </div>
                    </div>
                    ${isSeries ? `
                    <div class="w-full lg:w-80 flex-shrink-0 bg-zinc-800 rounded-lg p-4 shadow-lg flex flex-col">
                        <h3 class="text-2xl font-bold text-violet-400 mb-4 flex items-center gap-2">
                           ${icons.list} Episodes
                        </h3>
                        <div id="episode-list" class="flex-grow overflow-y-auto custom-scrollbar space-y-2">
                            ${currentEpisodes.map(episode => `
                                <div data-id="${episode._id}" data-type="episode" data-streaming-url="${episode.streamingUrl}" data-title="${seriesName} - S${currentSeason.seasonNumber}E${episode.episodeNumber}" data-season-id="${currentSeason.seasonNumber}" data-series-id="${selectedSeries._id}"
                                    class="episode-item flex items-center gap-2 p-3 rounded-lg cursor-pointer transition-colors ${selectedContent.id === episode._id ? 'bg-violet-600' : 'bg-zinc-700 hover:bg-violet-500'}">
                                    <div class="flex-shrink-0 text-violet-300">
                                        ${icons.play}
                                    </div>
                                    <div class="flex-grow">
                                        <p class="font-semibold text-gray-200 truncate">E${episode.episodeNumber}: ${episode.title}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>` : ''}
                </div>
            `;
            
            // Initialize Plyr and HLS
            const video = document.getElementById('video-player');
            let plyr;
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(selectedContent.streamingUrl);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    plyr = new Plyr(video);
                });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = selectedContent.streamingUrl;
                plyr = new Plyr(video);
            } else {
                plyr = new Plyr(video);
            }
            
            document.getElementById('back-button').addEventListener('click', () => {
                // Destroy the Plyr instance before leaving the page
                if (plyr) {
                    plyr.destroy();
                }
                header.classList.remove('hidden');
                view = isSeries ? 'series' : 'home';
                selectedContent = null;
                render();
            });
        }

        // --- MAIN RENDER FUNCTION ---
        function render() {
            if (view !== 'player') {
                header.classList.remove('hidden');
            }
            if (isLoading) {
                renderLoading();
            } else if (error) {
                renderError(error);
            } else {
                switch(view) {
                    case 'home':
                        renderHomePage();
                        break;
                    case 'series':
                        renderSeriesPage();
                        break;
                    case 'player':
                        renderPlayerPage();
                        break;
                }
            }
        }

        // --- EVENT LISTENERS ---
        appContainer.addEventListener('click', (e) => {
            const card = e.target.closest('[data-id]');
            if (!card) return;

            const type = card.dataset.type;
            const id = card.dataset.id;
            
            if (type === 'movie') {
                const movie = content.find(item => item._id === id);
                selectedContent = { ...movie, type: 'movie' };
                view = 'player';
                render();
            } else if (type === 'series') {
                fetchSeriesDetails(id);
            } else if (type === 'episode') {
                const newEpisode = {
                    id: card.dataset.id,
                    title: card.dataset.title,
                    streamingUrl: card.dataset.streamingUrl,
                    type: 'series',
                    seasonId: card.dataset.seasonId,
                };
                selectedContent = newEpisode;
                render();
            }
        });

        window.onload = () => {
            render();
        };
    </script>
</body>
</html>

