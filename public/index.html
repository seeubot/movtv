<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-black: #000000;
            --secondary-black: #1a1a1a;
            --accent-black: #2d2d2d;
            --primary-white: #ffffff;
            --secondary-white: #f0f0f0;
            --accent-white: #e0e0e0;
            --focus-color: #ffffff;
            --hover-color: #333333;
            --gradient-primary: linear-gradient(135deg, #000000 0%, #2d2d2d 100%);
            --gradient-secondary: linear-gradient(45deg, #1a1a1a 0%, #000000 100%);
        }

        body {
            font-family: 'Arial', sans-serif;
            background: var(--gradient-primary);
            color: var(--primary-white);
            overflow-x: hidden;
            line-height: 1.6;
        }

        .container {
            max-width: 100vw;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 2px solid var(--accent-black);
            margin-bottom: 30px;
        }

        .logo {
            font-size: 2.5rem;
            font-weight: bold;
            background: linear-gradient(45deg, var(--primary-white), var(--accent-white));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
        }

        .nav-btn {
            padding: 12px 24px;
            background: var(--secondary-black);
            border: 2px solid var(--accent-black);
            border-radius: 8px;
            color: var(--primary-white);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            font-weight: 500;
        }

        .nav-btn:hover,
        .nav-btn:focus {
            background: var(--primary-white);
            color: var(--primary-black);
            border-color: var(--primary-white);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 255, 255, 0.2);
            outline: none;
        }

        .nav-btn.active {
            background: var(--primary-white);
            color: var(--primary-black);
            border-color: var(--primary-white);
        }

        /* Search Section */
        .search-section {
            margin-bottom: 40px;
            text-align: center;
        }

        .search-container {
            position: relative;
            max-width: 600px;
            margin: 0 auto;
        }

        .search-input {
            width: 100%;
            padding: 18px 60px 18px 20px;
            font-size: 1.2rem;
            border: 2px solid var(--accent-black);
            border-radius: 50px;
            background: var(--secondary-black);
            color: var(--primary-white);
            outline: none;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: var(--primary-white);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
        }

        .search-input::placeholder {
            color: var(--accent-white);
        }

        .search-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--primary-white);
            color: var(--primary-black);
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .search-btn:hover,
        .search-btn:focus {
            background: var(--accent-white);
            transform: translateY(-50%) scale(1.1);
            outline: none;
        }

        /* Content Grid */
        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .media-card {
            background: var(--secondary-black);
            border: 2px solid var(--accent-black);
            border-radius: 15px;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .media-card:hover,
        .media-card:focus {
            transform: translateY(-8px) scale(1.02);
            border-color: var(--primary-white);
            box-shadow: 0 15px 40px rgba(255, 255, 255, 0.2);
            outline: none;
        }

        .media-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 0%, rgba(255, 255, 255, 0.1) 50%, transparent 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .media-card:hover::before {
            opacity: 1;
        }

        .media-thumbnail {
            width: 100%;
            height: 200px;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .media-card:hover .media-thumbnail {
            transform: scale(1.05);
        }

        .media-info {
            padding: 20px;
        }

        .media-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--primary-white);
        }

        .media-type {
            background: var(--primary-white);
            color: var(--primary-black);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-block;
        }

        /* Video Player */
        .video-player-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .video-player-container {
            position: relative;
            width: 90%;
            height: 85%;
            max-width: 1200px;
            background: var(--primary-black);
            border-radius: 15px;
            overflow: hidden;
            border: 3px solid var(--primary-white);
        }

        .video-element {
            width: 100%;
            height: calc(100% - 80px);
            object-fit: contain;
            background: var(--primary-black);
        }

        .video-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .video-player-container:hover .video-controls,
        .video-controls:focus-within {
            opacity: 1;
        }

        .control-btn {
            background: var(--primary-white);
            color: var(--primary-black);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .control-btn:hover,
        .control-btn:focus {
            background: var(--accent-white);
            transform: scale(1.1);
            outline: none;
        }

        .progress-container {
            flex: 1;
            height: 8px;
            background: var(--accent-black);
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: var(--primary-white);
            width: 0%;
            transition: width 0.1s ease;
            border-radius: 4px;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .volume-slider {
            width: 80px;
            height: 8px;
            background: var(--accent-black);
            border-radius: 4px;
            outline: none;
            cursor: pointer;
        }

        .time-display {
            color: var(--primary-white);
            font-size: 1rem;
            font-weight: 500;
            min-width: 120px;
            text-align: center;
        }

        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--primary-white);
            color: var(--primary-black);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-btn:hover,
        .close-btn:focus {
            background: var(--accent-white);
            transform: scale(1.1);
            outline: none;
        }

        /* Series Modal */
        .series-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            z-index: 500;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .series-modal-content {
            background: var(--gradient-secondary);
            border: 3px solid var(--primary-white);
            border-radius: 20px;
            max-width: 800px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            padding: 30px;
        }

        .series-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .series-title {
            font-size: 2rem;
            font-weight: bold;
        }

        .season-selector {
            margin-bottom: 30px;
        }

        .season-tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .season-tab {
            padding: 10px 20px;
            background: var(--accent-black);
            border: 2px solid var(--accent-black);
            border-radius: 25px;
            color: var(--primary-white);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .season-tab:hover,
        .season-tab:focus,
        .season-tab.active {
            background: var(--primary-white);
            color: var(--primary-black);
            border-color: var(--primary-white);
            outline: none;
        }

        .episodes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .episode-card {
            background: var(--secondary-black);
            border: 2px solid var(--accent-black);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .episode-card:hover,
        .episode-card:focus {
            border-color: var(--primary-white);
            background: var(--hover-color);
            transform: translateY(-2px);
            outline: none;
        }

        .episode-number {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--primary-white);
            margin-bottom: 5px;
        }

        .episode-title {
            color: var(--accent-white);
            font-size: 0.95rem;
        }

        /* Loading Spinner */
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2rem;
            color: var(--accent-white);
        }

        .spinner {
            border: 4px solid var(--accent-black);
            border-top: 4px solid var(--primary-white);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }

            .nav-buttons {
                flex-wrap: wrap;
                justify-content: center;
            }

            .logo {
                font-size: 2rem;
            }

            .content-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 20px;
            }

            .video-player-container {
                width: 95%;
                height: 90%;
            }

            .video-controls {
                padding: 15px;
                gap: 10px;
            }

            .control-btn {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }

            .volume-slider {
                width: 60px;
            }
        }

        @media (orientation: portrait) and (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .content-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 15px;
            }

            .media-thumbnail {
                height: 150px;
            }

            .video-player-container {
                width: 100%;
                height: 100%;
                border-radius: 0;
            }

            .video-controls {
                padding: 10px;
                gap: 8px;
            }

            .control-btn {
                width: 35px;
                height: 35px;
                font-size: 0.9rem;
            }
        }

        /* TV Remote Control Focus States */
        .focusable {
            position: relative;
        }

        .focusable:focus {
            outline: 3px solid var(--focus-color);
            outline-offset: 2px;
            z-index: 10;
        }

        /* Hide scrollbar but keep functionality */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--accent-black);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-white);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-white);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">🎬 MediaHub</div>
            <div class="nav-buttons">
                <button class="nav-btn focusable active" data-tab="all" tabindex="1">All</button>
                <button class="nav-btn focusable" data-tab="movies" tabindex="2">Movies</button>
                <button class="nav-btn focusable" data-tab="series" tabindex="3">Series</button>
                <button class="nav-btn focusable" id="debugBtn" tabindex="6" style="font-size: 0.8rem;">🔧 Debug</button>
            </div>
        </div>

        <!-- Search Section -->
        <div class="search-section">
            <div class="search-container">
                <input type="text" class="search-input focusable" placeholder="Search movies and series..." tabindex="4">
                <button class="search-btn focusable" tabindex="5">🔍</button>
            </div>
        </div>

        <!-- Content Grid -->
        <div class="content-grid" id="contentGrid">
            <div class="loading">
                <div class="spinner"></div>
                Loading your media library...
            </div>
        </div>
    </div>

    <!-- Video Player -->
    <div class="video-player-overlay" id="videoPlayer">
        <div class="video-player-container">
            <button class="close-btn focusable" id="closePlayer" tabindex="-1">×</button>
            <video class="video-element" id="videoElement" controls>
                Your browser does not support the video tag.
            </video>
            <div class="video-controls" id="videoControls">
                <button class="control-btn focusable" id="playPauseBtn" tabindex="-1">▶</button>
                <div class="progress-container focusable" id="progressContainer" tabindex="-1">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div class="volume-control">
                    <button class="control-btn focusable" id="muteBtn" tabindex="-1">🔊</button>
                    <input type="range" class="volume-slider focusable" id="volumeSlider" min="0" max="1" step="0.1" value="1" tabindex="-1">
                </div>
                <div class="time-display" id="timeDisplay">0:00 / 0:00</div>
                <button class="control-btn focusable" id="fullscreenBtn" tabindex="-1">⛶</button>
            </div>
        </div>
    </div>

    <!-- Series Modal -->
    <div class="series-modal" id="seriesModal">
        <div class="series-modal-content">
            <div class="series-header">
                <h2 class="series-title" id="seriesTitle"></h2>
                <button class="close-btn focusable" id="closeSeriesModal" tabindex="-1">×</button>
            </div>
            <div class="season-selector">
                <div class="season-tabs" id="seasonTabs"></div>
            </div>
            <div class="episodes-grid" id="episodesGrid"></div>
        </div>
    </div>

    <script>
        // API Configuration - Dynamic URL detection
        const API_BASE_URL = (() => {
            // Check if we're in development or production
            const hostname = window.location.hostname;
            const port = window.location.port;
            const protocol = window.location.protocol;
            
            // If we're on localhost, use the backend port
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return `${protocol}//${hostname}:8000/api`;
            } else {
                // Production - use same host
                return `${protocol}//${hostname}${port ? ':' + port : ''}/api`;
            }
        })();

        console.log('API Base URL:', API_BASE_URL);

        // Global variables
        let allMedia = [];
        let filteredMedia = [];
        let currentTab = 'all';
        let currentSeries = null;
        let currentSeason = 1;
        let focusIndex = 0;
        let focusableElements = [];

        // Initialize app with debug info
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('🚀 MediaHub Frontend Starting...');
            console.log('Current URL:', window.location.href);
            console.log('API Base URL:', API_BASE_URL);
            
            await loadMedia();
            setupEventListeners();
            setupRemoteControl();
            updateFocusableElements();
            
            // Add debug button functionality
            document.getElementById('debugBtn').addEventListener('click', showDebugInfo);
        });

        // Debug information function
        async function showDebugInfo() {
            try {
                const healthResponse = await fetch(`${API_BASE_URL.replace('/api', '')}/health`);
                const healthData = await healthResponse.json();
                
                const debugInfo = `
🔧 DEBUG INFORMATION

📍 Frontend URL: ${window.location.href}
🌐 API Base URL: ${API_BASE_URL}
🏥 Health Endpoint: ${API_BASE_URL.replace('/api', '')}/health
📊 Server Status: ${healthData.status}
🤖 Bot Mode: ${healthData.bot}
💾 MongoDB: ${healthData.mongodb}
⏰ Server Time: ${healthData.timestamp}

📱 Frontend Stats:
- Total Media Items: ${allMedia.length}
- Movies: ${allMedia.filter(m => m.type === 'movie').length}
- Series: ${allMedia.filter(m => m.type === 'series').length}
- Current Tab: ${currentTab}
- Filtered Items: ${filteredMedia.length}

🖥️ Browser Info:
- User Agent: ${navigator.userAgent}
- Screen: ${screen.width}x${screen.height}
- Viewport: ${window.innerWidth}x${window.innerHeight}
                `.trim();
                
                alert(debugInfo);
            } catch (error) {
                const errorInfo = `
❌ DEBUG - CONNECTION ERROR

📍 Frontend URL: ${window.location.href}
🌐 API Base URL: ${API_BASE_URL}
🚫 Error: ${error.message}

🔧 Troubleshooting:
1. Check if backend server is running
2. Verify the port number (should be 8000)
3. Check for CORS issues
4. Ensure BOT_TOKEN and MONGODB_URI are set

💡 Try accessing directly: ${API_BASE_URL.replace('/api', '')}/health
                `.trim();
                
                alert(errorInfo);
                console.error('Debug error:', error);
            }
        }

        // Load media from API with better error handling
        async function loadMedia() {
            try {
                console.log('Loading media from:', API_BASE_URL);
                
                // Test API connection first
                const healthResponse = await fetch(`${API_BASE_URL.replace('/api', '')}/health`);
                if (!healthResponse.ok) {
                    throw new Error('Backend server is not responding');
                }
                
                const [moviesResponse, seriesResponse] = await Promise.all([
                    fetch(`${API_BASE_URL}/movies`).catch(err => {
                        console.warn('Movies endpoint failed:', err);
                        return { ok: false, json: () => [] };
                    }),
                    fetch(`${API_BASE_URL}/series`).catch(err => {
                        console.warn('Series endpoint failed:', err);
                        return { ok: false, json: () => [] };
                    })
                ]);

                let movies = [];
                let series = [];

                if (moviesResponse.ok) {
                    movies = await moviesResponse.json();
                    console.log('Loaded movies:', movies.length);
                } else {
                    console.warn('Failed to load movies');
                }

                if (seriesResponse.ok) {
                    series = await seriesResponse.json();
                    console.log('Loaded series:', series.length);
                } else {
                    console.warn('Failed to load series');
                }

                allMedia = [
                    ...movies.map(movie => ({ ...movie, type: 'movie' })),
                    ...series.map(s => ({ ...s, type: 'series' }))
                ];

                filteredMedia = [...allMedia];
                renderMedia();
                
                if (allMedia.length === 0) {
                    document.getElementById('contentGrid').innerHTML = `
                        <div class="loading">
                            <p style="color: #f0f0f0;">✨ Your media library is empty!</p>
                            <p style="color: #999; margin-top: 10px;">Use your Telegram bot to add movies and series.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading media:', error);
                document.getElementById('contentGrid').innerHTML = `
                    <div class="loading">
                        <p style="color: #ff6b6b; margin-bottom: 15px;">❌ Unable to connect to server</p>
                        <p style="color: #999; font-size: 0.9rem; margin-bottom: 15px;">
                            API URL: ${API_BASE_URL}
                        </p>
                        <p style="color: #ccc; font-size: 0.85rem;">
                            Make sure your backend server is running on the correct port.
                        </p>
                        <button class="nav-btn" onclick="location.reload()" style="margin-top: 20px;">
                            🔄 Retry Connection
                        </button>
                    </div>
                `;
            }
        }

        // Render media grid
        function renderMedia() {
            const contentGrid = document.getElementById('contentGrid');
            
            if (filteredMedia.length === 0) {
                contentGrid.innerHTML = `
                    <div class="loading">
                        <p>No media found matching your criteria.</p>
                    </div>
                `;
                return;
            }

            contentGrid.innerHTML = filteredMedia.map((media, index) => `
                <div class="media-card focusable" tabindex="${10 + index}" data-media='${JSON.stringify(media)}'>
                    <img src="${media.thumbnail}" alt="${media.name}" class="media-thumbnail" 
                         onerror="this.src='data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"280\" height=\"200\" viewBox=\"0 0 280 200\"><rect width=\"280\" height=\"200\" fill=\"%232d2d2d\"/><text x=\"140\" y=\"100\" text-anchor=\"middle\" dy=\".3em\" fill=\"%23ffffff\" font-size=\"20\">No Image</text></svg>'">
                    <div class="media-info">
                        <div class="media-title">${media.name}</div>
                        <span class="media-type">${media.type === 'movie' ? '🎬 Movie' : '📺 Series'}</span>
                    </div>
                </div>
            `).join('');

            updateFocusableElements();
        }

        // Setup event listeners
        function setupEventListeners() {
            // Tab navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tab = e.target.dataset.tab;
                    switchTab(tab);
                });
            });

            // Search functionality
            const searchInput = document.querySelector('.search-input');
            const searchBtn = document.querySelector('.search-btn');

            const performSearch = () => {
                const query = searchInput.value.toLowerCase().trim();
                if (query) {
                    filteredMedia = allMedia.filter(media =>
                        media.name.toLowerCase().includes(query)
                    );
                } else {
                    filterByTab(currentTab);
                }
                renderMedia();
            };

            searchBtn.addEventListener('click', performSearch);
            searchInput.addEventListener('input', debounce(performSearch, 300));

            // Media card clicks
            document.addEventListener('click', (e) => {
                const mediaCard = e.target.closest('.media-card');
                if (mediaCard) {
                    const media = JSON.parse(mediaCard.dataset.media);
                    if (media.type === 'movie') {
                        playVideo(media.streamingUrl, media.name);
                    } else {
                        openSeriesModal(media);
                    }
                }
            });

            // Video player controls
            setupVideoPlayer();
            
            // Series modal
            setupSeriesModal();
        }

        // Setup video player
        function setupVideoPlayer() {
            const videoPlayer = document.getElementById('videoPlayer');
            const videoElement = document.getElementById('videoElement');
            const closePlayer = document.getElementById('closePlayer');
            const playPauseBtn = document.getElementById('playPauseBtn');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const muteBtn = document.getElementById('muteBtn');
            const volumeSlider = document.getElementById('volumeSlider');
            const timeDisplay = document.getElementById('timeDisplay');
            const fullscreenBtn = document.getElementById('fullscreenBtn');

            closePlayer.addEventListener('click', closeVideoPlayer);

            playPauseBtn.addEventListener('click', () => {
                if (videoElement.paused) {
                    videoElement.play();
                    playPauseBtn.textContent = '⏸';
                } else {
                    videoElement.pause();
                    playPauseBtn.textContent = '▶';
                }
            });

            videoElement.addEventListener('play', () => playPauseBtn.textContent = '⏸');
            videoElement.addEventListener('pause', () => playPauseBtn.textContent = '▶');

            progressContainer.addEventListener('click', (e) => {
                const rect = progressContainer.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const percentage = clickX / rect.width;
                videoElement.currentTime = percentage * videoElement.duration;
            });

            videoElement.addEventListener('timeupdate', () => {
                if (videoElement.duration) {
                    const percentage = (videoElement.currentTime / videoElement.duration) * 100;
                    progressBar.style.width = percentage + '%';
                    
                    const currentMin = Math.floor(videoElement.currentTime / 60);
                    const currentSec = Math.floor(videoElement.currentTime % 60);
                    const totalMin = Math.floor(videoElement.duration / 60);
                    const totalSec = Math.floor(videoElement.duration % 60);
                    
                    timeDisplay.textContent = `${currentMin}:${currentSec.toString().padStart(2, '0')} / ${totalMin}:${totalSec.toString().padStart(2, '0')}`;
                }
            });

            muteBtn.addEventListener('click', () => {
                videoElement.muted = !videoElement.muted;
                muteBtn.textContent = videoElement.muted ? '🔇' : '🔊';
                volumeSlider.value = videoElement.muted ? 0 : videoElement.volume;
            });

            volumeSlider.addEventListener('input', (e) => {
                videoElement.volume = e.target.value;
                videoElement.muted = e.target.value == 0;
                muteBtn.textContent = videoElement.muted ? '🔇' : '🔊';
            });

            fullscreenBtn.addEventListener('click', () => {
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                } else {
                    videoPlayer.requestFullscreen();
                }
            });
        }

        // Setup series modal
        function setupSeriesModal() {
            document.getElementById('closeSeriesModal').addEventListener('click', closeSeriesModal);
            
            document.addEventListener('click', (e) => {
                if (e.target.id === 'seriesModal') {
                    closeSeriesModal();
                }
            });
        }

        // Remote control navigation
        function setupRemoteControl() {
            document.addEventListener('keydown', (e) => {
                switch (e.key) {
                    case 'ArrowUp':
                        e.preventDefault();
                        navigateFocus('up');
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        navigateFocus('down');
                        break;
                    case 'ArrowLeft':
                        e.preventDefault();
                        navigateFocus('left');
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        navigateFocus('right');
                        break;
                    case 'Enter':
                        e.preventDefault();
                        activateCurrentFocus();
                        break;
                    case 'Escape':
                        e.preventDefault();
                        handleEscape();
                        break;
                    case ' ':
                        e.preventDefault();
                        if (document.getElementById('videoPlayer').style.display === 'flex') {
                            document.getElementById('playPauseBtn').click();
                        }
                        break;
                }
            });
        }

        // Focus navigation functions
        function updateFocusableElements() {
            focusableElements = Array.from(document.querySelectorAll('.focusable:not([tabindex="-1"])'));
            if (focusableElements.length > 0 && focusIndex >= focusableElements.length) {
                focusIndex = 0;
            }
        }

        function navigateFocus(direction) {
            if (focusableElements.length === 0) return;

            focusableElements[focusIndex].blur();

            switch (direction) {
                case 'up':
                    focusIndex = Math.max(0, focusIndex - getColumnsCount());
                    break;
                case 'down':
                    focusIndex = Math.min(focusableElements.length - 1, focusIndex + getColumnsCount());
                    break;
                case 'left':
                    focusIndex = Math.max(0, focusIndex - 1);
                    break;
                case 'right':
                    focusIndex = Math.min(focusableElements.length - 1, focusIndex + 1);
                    break;
            }

            focusableElements[focusIndex].focus();
        }

        function getColumnsCount() {
            // Estimate columns based on screen width
            const screenWidth = window.innerWidth;
            if (screenWidth < 768) return 1;
            if (screenWidth < 1200) return 2;
            return Math.floor(screenWidth / 320);
        }

        function activateCurrentFocus() {
            if (focusableElements.length > 0) {
                focusableElements[focusIndex].click();
            }
        }

        function handleEscape() {
            if (document.getElementById('videoPlayer').style.display === 'flex') {
                closeVideoPlayer();
            } else if (document.getElementById('seriesModal').style.display === 'flex') {
                closeSeriesModal();
            }
        }

        // Tab switching
        function switchTab(tab) {
            currentTab = tab;
            
            // Update active button
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });

            filterByTab(tab);
            renderMedia();
        }

        function filterByTab(tab) {
            switch (tab) {
                case 'movies':
                    filteredMedia = allMedia.filter(media => media.type === 'movie');
                    break;
                case 'series':
                    filteredMedia = allMedia.filter(media => media.type === 'series');
                    break;
                default:
                    filteredMedia = [...allMedia];
            }
        }

        // Video player functions
        function playVideo(url, title) {
            const videoPlayer = document.getElementById('videoPlayer');
            const videoElement = document.getElementById('videoElement');
            
            videoElement.src = url;
            videoElement.load();
            videoPlayer.style.display = 'flex';
            
            // Focus on video element
            setTimeout(() => {
                videoElement.focus();
                videoElement.play().catch(e => console.log('Autoplay prevented:', e));
            }, 100);
        }

        function closeVideoPlayer() {
            const videoPlayer = document.getElementById('videoPlayer');
            const videoElement = document.getElementById('videoElement');
            
            videoElement.pause();
            videoElement.src = '';
            videoPlayer.style.display = 'none';
            
            // Return focus to main content
            updateFocusableElements();
            if (focusableElements.length > 0) {
                focusableElements[focusIndex].focus();
            }
        }

        // Series modal functions with better error handling
        async function openSeriesModal(series) {
            try {
                console.log('Loading series details for:', series._id);
                const response = await fetch(`${API_BASE_URL}/series/${series._id}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                currentSeries = await response.json();
                console.log('Series loaded:', currentSeries);
                
                document.getElementById('seriesTitle').textContent = currentSeries.name;
                
                if (currentSeries.seasons && currentSeries.seasons.length > 0) {
                    currentSeason = currentSeries.seasons[0].seasonNumber;
                    renderSeasonTabs();
                    renderEpisodes();
                } else {
                    document.getElementById('seasonTabs').innerHTML = '';
                    document.getElementById('episodesGrid').innerHTML = `
                        <p style="text-align: center; color: #999;">No seasons available for this series.</p>
                    `;
                }
                
                document.getElementById('seriesModal').style.display = 'flex';
                
                // Focus on first season tab
                setTimeout(() => {
                    const firstTab = document.querySelector('.season-tab');
                    if (firstTab) {
                        firstTab.focus();
                    } else {
                        document.getElementById('closeSeriesModal').focus();
                    }
                }, 100);
                
            } catch (error) {
                console.error('Error loading series details:', error);
                alert(`Error loading series details: ${error.message}`);
            }
        }

        function closeSeriesModal() {
            document.getElementById('seriesModal').style.display = 'none';
            currentSeries = null;
            
            // Return focus to main content
            updateFocusableElements();
            if (focusableElements.length > 0) {
                focusableElements[focusIndex].focus();
            }
        }

        function renderSeasonTabs() {
            const seasonTabs = document.getElementById('seasonTabs');
            
            seasonTabs.innerHTML = currentSeries.seasons.map(season => `
                <button class="season-tab focusable ${season.seasonNumber === currentSeason ? 'active' : ''}" 
                        data-season="${season.seasonNumber}" tabindex="-1">
                    Season ${season.seasonNumber}
                </button>
            `).join('');

            // Add click listeners to season tabs
            seasonTabs.addEventListener('click', (e) => {
                if (e.target.classList.contains('season-tab')) {
                    currentSeason = parseInt(e.target.dataset.season);
                    
                    // Update active tab
                    seasonTabs.querySelectorAll('.season-tab').forEach(tab => {
                        tab.classList.toggle('active', parseInt(tab.dataset.season) === currentSeason);
                    });
                    
                    renderEpisodes();
                }
            });
        }

        function renderEpisodes() {
            const episodesGrid = document.getElementById('episodesGrid');
            const season = currentSeries.seasons.find(s => s.seasonNumber === currentSeason);
            
            if (!season || !season.episodes.length) {
                episodesGrid.innerHTML = '<p style="text-align: center; color: #999;">No episodes found for this season.</p>';
                return;
            }

            episodesGrid.innerHTML = season.episodes.map(episode => `
                <div class="episode-card focusable" tabindex="-1" 
                     data-url="${episode.streamingUrl}" 
                     data-title="S${season.seasonNumber}E${episode.episodeNumber}: ${episode.title}">
                    <div class="episode-number">Episode ${episode.episodeNumber}</div>
                    <div class="episode-title">${episode.title}</div>
                </div>
            `).join('');

            // Add click listeners to episodes
            episodesGrid.addEventListener('click', (e) => {
                const episodeCard = e.target.closest('.episode-card');
                if (episodeCard) {
                    const url = episodeCard.dataset.url;
                    const title = episodeCard.dataset.title;
                    closeSeriesModal();
                    playVideo(url, title);
                }
            });
        }

        // Utility functions
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Screen orientation handling
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                updateFocusableElements();
                renderMedia();
            }, 100);
        });

        // Responsive grid adjustment
        window.addEventListener('resize', debounce(() => {
            updateFocusableElements();
        }, 250));

        // Auto-refresh data every 30 seconds
        setInterval(async () => {
            try {
                await loadMedia();
            } catch (error) {
                console.log('Auto-refresh failed:', error);
            }
        }, 30000);

        // Initialize focus on first load
        window.addEventListener('load', () => {
            setTimeout(() => {
                updateFocusableElements();
                if (focusableElements.length > 0) {
                    focusableElements[0].focus();
                }
            }, 500);
        });

        // Enhanced video player with more controls
        document.addEventListener('DOMContentLoaded', () => {
            const videoElement = document.getElementById('videoElement');
            
            // Add more video event handlers
            videoElement.addEventListener('loadeddata', () => {
                console.log('Video loaded successfully');
            });
            
            videoElement.addEventListener('error', (e) => {
                console.error('Video error:', e);
                alert('Error loading video. Please try again or check the video URL.');
            });
            
            videoElement.addEventListener('ended', () => {
                document.getElementById('playPauseBtn').textContent = '▶';
            });
        });

        // Touch support for mobile devices
        let touchStartY = 0;
        let touchStartX = 0;

        document.addEventListener('touchstart', (e) => {
            touchStartY = e.touches[0].clientY;
            touchStartX = e.touches[0].clientX;
        });

        document.addEventListener('touchend', (e) => {
            if (!touchStartY || !touchStartX) return;

            const touchEndY = e.changedTouches[0].clientY;
            const touchEndX = e.changedTouches[0].clientX;
            const diffY = touchStartY - touchEndY;
            const diffX = touchStartX - touchEndX;

            // Minimum swipe distance
            if (Math.abs(diffY) > 50 || Math.abs(diffX) > 50) {
                if (Math.abs(diffY) > Math.abs(diffX)) {
                    // Vertical swipe
                    if (diffY > 0) {
                        navigateFocus('up');
                    } else {
                        navigateFocus('down');
                    }
                } else {
                    // Horizontal swipe
                    if (diffX > 0) {
                        navigateFocus('left');
                    } else {
                        navigateFocus('right');
                    }
                }
            }

            touchStartY = 0;
            touchStartX = 0;
        });

        // Picture-in-Picture support
        if ('pictureInPictureEnabled' in document) {
            const pipBtn = document.createElement('button');
            pipBtn.className = 'control-btn focusable';
            pipBtn.innerHTML = '📺';
            pipBtn.title = 'Picture in Picture';
            pipBtn.tabIndex = -1;
            
            pipBtn.addEventListener('click', async () => {
                const video = document.getElementById('videoElement');
                try {
                    if (video !== document.pictureInPictureElement) {
                        await video.requestPictureInPicture();
                    } else {
                        await document.exitPictureInPicture();
                    }
                } catch (error) {
                    console.error('PiP error:', error);
                }
            });
            
            // Add PiP button to controls
            document.getElementById('fullscreenBtn').parentNode.insertBefore(pipBtn, document.getElementById('fullscreenBtn'));
        }
    </script>
</body>
</html>
