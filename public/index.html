<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Library</title>
    <!-- Inter font for a clean, modern look -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
    <!-- Tailwind CSS for a modern, responsive design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        
        /* Backdrop filter for a frosted glass effect on the video container */
        #video-player-container {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            background-color: rgba(0, 0, 0, 0.4);
            transition: all 0.5s ease-in-out;
        }

        /* Styles for the custom message box */
        .message-box {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
        }
        .message-box.show {
            opacity: 1;
            pointer-events: auto;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col h-screen overflow-hidden bg-gradient-to-br from-gray-900 to-black">
    <!-- Main application container with a responsive layout -->
    <div id="app-container" class="flex-grow flex flex-col md:flex-row h-full transition-all duration-500 ease-in-out">

        <!-- Sidebar/Content Section -->
        <div id="sidebar" class="w-full flex-shrink-0 md:w-1/3 flex flex-col bg-gray-800 p-4 overflow-y-auto rounded-lg md:m-4 shadow-xl transition-all duration-500 ease-in-out">
            <!-- Header with Search and Navigation -->
            <div class="flex-shrink-0 mb-4">
                <h1 class="text-3xl font-bold text-center mb-4 text-blue-400">Media Library</h1>
                
                <!-- Search bar input -->
                <div class="relative mb-4">
                    <input type="text" id="search-input" placeholder="Search for titles..." class="w-full p-3 pl-10 rounded-full bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-md">
                    <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                    </svg>
                </div>

                <!-- View Toggle Buttons -->
                <div class="flex space-x-2 p-1 bg-gray-700 rounded-full">
                    <button id="show-movies-btn" class="flex-1 p-2 rounded-full font-semibold transition-colors duration-200 bg-blue-600 hover:bg-blue-700">Movies</button>
                    <button id="show-series-btn" class="flex-1 p-2 rounded-full font-semibold transition-colors duration-200 bg-gray-700 hover:bg-gray-600">Series</button>
                </div>
            </div>

            <!-- Content Area (Movies/Series grid) -->
            <div id="content-area" class="flex-grow grid grid-cols-2 sm:grid-cols-3 md:grid-cols-2 lg:grid-cols-3 gap-4 pt-4 overflow-y-auto">
                <!-- Content will be dynamically injected here -->
            </div>

            <!-- Loader element -->
            <div id="loader" class="hidden flex-grow flex items-center justify-center">
                <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent"></div>
            </div>

            <!-- Empty State message -->
            <div id="empty-state" class="hidden flex-grow items-center justify-center text-center text-gray-400">
                <p>No media found. Try adding some via the Telegram bot!</p>
            </div>
        </div>

        <!-- Video Player Section (initially hidden, takes full width on landscape mobile) -->
        <div id="video-player-container" class="hidden w-full md:w-2/3 h-full flex-shrink-0 flex-col justify-center items-center relative rounded-lg m-4 shadow-xl">
            <!-- The HTML5 video element for playback -->
            <video id="video-player" class="w-full h-full object-contain" controls autoplay playsinline></video>
        </div>
    </div>

    <!-- Series Modal to display seasons and episodes -->
    <div id="series-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50 hidden transition-opacity duration-300">
        <div class="bg-gray-800 rounded-lg max-w-2xl w-full p-6 relative shadow-2xl">
            <button id="close-modal-btn" class="absolute top-3 right-3 text-gray-400 hover:text-white text-2xl font-bold transition-colors duration-200">&times;</button>
            <h2 id="modal-title" class="text-2xl font-bold mb-4"></h2>
            <div id="seasons-container" class="overflow-y-auto max-h-[70vh]">
                <!-- Seasons and episodes will be injected here -->
            </div>
        </div>
    </div>

    <script>
        // The API base URL will be dynamically set based on the current URL.
        const API_BASE_URL = `${window.location.protocol}//${window.location.host}/api`;
        
        // Element references
        const contentArea = document.getElementById('content-area');
        const showMoviesBtn = document.getElementById('show-movies-btn');
        const showSeriesBtn = document.getElementById('show-series-btn');
        const searchInput = document.getElementById('search-input');
        const videoPlayer = document.getElementById('video-player');
        const videoPlayerContainer = document.getElementById('video-player-container');
        const loader = document.getElementById('loader');
        const emptyState = document.getElementById('empty-state');
        const seriesModal = document.getElementById('series-modal');
        const closeBtn = document.getElementById('close-modal-btn');
        const modalTitle = document.getElementById('modal-title');
        const seasonsContainer = document.getElementById('seasons-container');
        const sidebar = document.getElementById('sidebar');
        const appContainer = document.getElementById('app-container');

        let currentView = 'movies';

        // Helper function to show/hide elements
        const show = (element) => element.classList.remove('hidden');
        const hide = (element) => element.classList.add('hidden');
        
        // Helper to format season and episode numbers with leading zeros
        const formatEpisodeNumber = (num) => String(num).padStart(2, '0');

        // Function to fetch and render movies from the API
        async function fetchAndRenderMovies(searchQuery = '') {
            hidePlayer();
            show(loader);
            hide(contentArea);
            hide(emptyState);
            try {
                const url = searchQuery ? `${API_BASE_URL}/movies?search=${encodeURIComponent(searchQuery)}` : `${API_BASE_URL}/movies`;
                const response = await fetch(url);
                const movies = await response.json();
                
                contentArea.innerHTML = '';
                if (movies.length === 0) {
                    show(emptyState);
                } else {
                    movies.forEach(movie => {
                        const card = document.createElement('div');
                        card.className = 'relative group cursor-pointer overflow-hidden rounded-lg shadow-lg transform hover:scale-105 transition-transform duration-300';
                        card.innerHTML = `
                            <img src="${movie.thumbnail}" alt="${movie.name}" class="w-full h-48 object-cover rounded-t-lg transition-opacity duration-300 group-hover:opacity-75" onerror="this.onerror=null;this.src='https://placehold.co/400x300/1f2937/d1d5db?text=No+Image';">
                            <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black to-transparent p-4">
                                <h3 class="text-lg font-semibold truncate">${movie.name}</h3>
                            </div>
                        `;
                        // Event listener to play the movie when clicked
                        card.addEventListener('click', () => {
                            playVideo(movie.streamingUrl, movie.name);
                        });
                        contentArea.appendChild(card);
                    });
                    show(contentArea);
                }
            } catch (error) {
                console.error('Error fetching movies:', error);
                contentArea.innerHTML = '<p class="text-red-500 text-center">Failed to load movies. Please check the server connection.</p>';
                show(contentArea);
            } finally {
                hide(loader);
            }
        }

        // Function to fetch and render series from the API
        async function fetchAndRenderSeries(searchQuery = '') {
            hidePlayer();
            show(loader);
            hide(contentArea);
            hide(emptyState);
            try {
                const url = searchQuery ? `${API_BASE_URL}/series?search=${encodeURIComponent(searchQuery)}` : `${API_BASE_URL}/series`;
                const response = await fetch(url);
                const seriesList = await response.json();
                
                contentArea.innerHTML = '';
                if (seriesList.length === 0) {
                    show(emptyState);
                } else {
                    seriesList.forEach(series => {
                        const card = document.createElement('div');
                        card.className = 'relative group cursor-pointer overflow-hidden rounded-lg shadow-lg transform hover:scale-105 transition-transform duration-300';
                        card.innerHTML = `
                            <img src="${series.thumbnail}" alt="${series.name}" class="w-full h-48 object-cover rounded-t-lg transition-opacity duration-300 group-hover:opacity-75" onerror="this.onerror=null;this.src='https://placehold.co/400x300/1f2937/d1d5db?text=No+Image';">
                            <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black to-transparent p-4">
                                <h3 class="text-lg font-semibold truncate">${series.name}</h3>
                            </div>
                        `;
                        // Event listener to show series details when clicked
                        card.addEventListener('click', () => showSeriesDetails(series._id));
                        contentArea.appendChild(card);
                    });
                    show(contentArea);
                }
            } catch (error) {
                console.error('Error fetching series:', error);
                contentArea.innerHTML = '<p class="text-red-500 text-center">Failed to load series. Please check the server connection.</p>';
                show(contentArea);
            } finally {
                hide(loader);
            }
        }

        // Function to display series details in a modal
        async function showSeriesDetails(seriesId) {
            try {
                const response = await fetch(`${API_BASE_URL}/series/${seriesId}`);
                const series = await response.json();
                
                modalTitle.textContent = series.name;
                seasonsContainer.innerHTML = '';

                series.seasons.sort((a, b) => a.seasonNumber - b.seasonNumber).forEach(season => {
                    const seasonDiv = document.createElement('div');
                    seasonDiv.className = 'mb-4';
                    
                    const seasonHeading = document.createElement('h3');
                    seasonHeading.className = 'text-xl font-bold mb-2 cursor-pointer text-gray-300 hover:text-white transition-colors duration-200';
                    seasonHeading.textContent = `Season ${season.seasonNumber}`;
                    seasonDiv.appendChild(seasonHeading);

                    const episodesList = document.createElement('ul');
                    episodesList.className = 'hidden space-y-2 pl-4';
                    seasonDiv.appendChild(episodesList);

                    // Toggle episodes list visibility
                    seasonHeading.addEventListener('click', () => {
                        episodesList.classList.toggle('hidden');
                        seasonHeading.classList.toggle('text-white');
                        seasonHeading.classList.toggle('text-gray-300');
                    });

                    season.episodes.sort((a, b) => a.episodeNumber - b.episodeNumber).forEach(episode => {
                        const episodeItem = document.createElement('li');
                        episodeItem.className = 'flex items-center space-x-3 p-2 rounded-lg bg-gray-700 hover:bg-gray-600 transition-colors duration-200 cursor-pointer';
                        
                        episodeItem.innerHTML = `
                            <span class="font-semibold text-blue-400">E${formatEpisodeNumber(episode.episodeNumber)}</span>
                            <span class="flex-1 truncate">${episode.title}</span>
                            <svg class="w-6 h-6 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path>
                            </svg>
                        `;
                        // Event listener to play an episode when clicked
                        episodeItem.addEventListener('click', () => {
                            playVideo(episode.streamingUrl, `S${season.seasonNumber}E${episode.episodeNumber}: ${episode.title}`);
                            hide(seriesModal);
                        });
                        episodesList.appendChild(episodeItem);
                    });
                    seasonsContainer.appendChild(seasonDiv);
                });

                show(seriesModal);
            } catch (error) {
                console.error('Error fetching series details:', error);
                showMessage('Failed to load series details. Please try again.');
            }
        }
        
        // Function to load and play a video
        function playVideo(url, title) {
            // Adjust layout for player visibility
            appContainer.classList.add('md:flex-row');
            appContainer.classList.remove('md:flex-col');
            sidebar.classList.add('md:w-1/3');
            sidebar.classList.remove('md:w-full');
            
            show(videoPlayerContainer);
            
            // Set the video source and play
            videoPlayer.src = url;
            videoPlayer.title = title;
            videoPlayer.autoplay = true;
            videoPlayer.load();
            
            // On mobile, hide the sidebar to give player full screen
            if (window.innerWidth < 768) {
                hide(sidebar);
            }
        }
        
        // Function to hide the video player and reset layout
        function hidePlayer() {
            hide(videoPlayerContainer);
            appContainer.classList.remove('md:flex-row');
            appContainer.classList.add('md:flex-col');
            sidebar.classList.remove('md:w-1/3');
            sidebar.classList.add('md:w-full');
            show(sidebar);
            videoPlayer.pause();
            videoPlayer.src = '';
        }

        // Event listeners for UI interaction
        showMoviesBtn.addEventListener('click', () => {
            currentView = 'movies';
            showMoviesBtn.classList.replace('bg-gray-700', 'bg-blue-600');
            showMoviesBtn.classList.replace('hover:bg-gray-600', 'hover:bg-blue-700');
            showSeriesBtn.classList.replace('bg-blue-600', 'bg-gray-700');
            showSeriesBtn.classList.replace('hover:bg-blue-700', 'hover:bg-gray-600');
            fetchAndRenderMovies(searchInput.value);
        });

        showSeriesBtn.addEventListener('click', () => {
            currentView = 'series';
            showSeriesBtn.classList.replace('bg-gray-700', 'bg-blue-600');
            showSeriesBtn.classList.replace('hover:bg-gray-600', 'hover:bg-blue-700');
            showMoviesBtn.classList.replace('bg-blue-600', 'bg-gray-700');
            showMoviesBtn.classList.replace('hover:bg-blue-700', 'hover:bg-gray-600');
            fetchAndRenderSeries(searchInput.value);
        });

        searchInput.addEventListener('input', () => {
            if (currentView === 'movies') {
                fetchAndRenderMovies(searchInput.value);
            } else {
                fetchAndRenderSeries(searchInput.value);
            }
        });

        closeBtn.addEventListener('click', () => {
            hide(seriesModal);
        });
        
        // Handle mobile screen size changes for UI responsiveness
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 768) {
                // Restore layout on desktop/tablet
                if (videoPlayer.paused === false && videoPlayer.src !== '') {
                    show(sidebar);
                } else {
                    show(sidebar);
                }
            } else {
                // On mobile, if player is active, hide sidebar in landscape
                const isLandscape = window.matchMedia("(orientation: landscape)").matches;
                if (videoPlayer.paused === false && videoPlayer.src !== '' && isLandscape) {
                    hide(sidebar);
                } else {
                    show(sidebar);
                }
            }
        });

        // Initial content load when the page is ready
        window.onload = () => {
          fetchAndRenderMovies();
        };

        // Custom function for showing toast-like messages
        function showMessage(message) {
            const messageBox = document.createElement('div');
            messageBox.className = 'message-box bg-red-600 text-white p-4 rounded-lg shadow-xl';
            messageBox.textContent = message;
            document.body.appendChild(messageBox);
            
            // Show the message
            setTimeout(() => {
                messageBox.classList.add('show');
            }, 10);
            
            // Hide and remove the message after 3 seconds
            setTimeout(() => {
                messageBox.classList.remove('show');
                setTimeout(() => messageBox.remove(), 300);
            }, 3000);
        }

    </script>
</body>
</html>

